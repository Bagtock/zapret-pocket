name: Build Zapret Pocket
run-name: ${{ github.ref_name || 'Manual Build' }}

on:
  workflow_dispatch:
  push:
    tags:
      - '[0-9]+*'

jobs:
  build-zapret:
    name: Build zapret for Android ${{ matrix.abi }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - abi: armeabi-v7a
            target: armv7a-linux-androideabi
          - abi: arm64-v8a
            target: aarch64-linux-android
          - abi: x86
            target: i686-linux-android
          - abi: x86_64
            target: x86_64-linux-android

    steps:
      - uses: actions/checkout@v4
        with:
          repository: bol-van/zapret
          path: zapret

      - name: Build zapret
        env:
          ABI: ${{ matrix.abi }}
          TARGET: ${{ matrix.target }}
        run: |
          DEPS_DIR=$GITHUB_WORKSPACE/deps
          export TOOLCHAIN=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64
          export API=21
          export CC="$TOOLCHAIN/bin/clang --target=$TARGET$API"
          export AR=$TOOLCHAIN/bin/llvm-ar
          export AS=$CC
          export LD=$TOOLCHAIN/bin/ld
          export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
          export STRIP=$TOOLCHAIN/bin/llvm-strip
          export PKG_CONFIG_PATH=$DEPS_DIR/lib/pkgconfig

          # Build dependencies
          curl -sSL https://www.netfilter.org/pub/libnfnetlink/libnfnetlink-1.0.2.tar.bz2 | tar -xj
          curl -sSL https://www.netfilter.org/pub/libmnl/libmnl-1.0.5.tar.bz2 | tar -xj
          curl -sSL https://www.netfilter.org/pub/libnetfilter_queue/libnetfilter_queue-1.0.5.tar.bz2 | tar -xj
          curl -sSL https://raw.githubusercontent.com/bol-van/zapret/master/.github/workflows/libnetfilter_queue-android.patch | patch -p1 -d libnetfilter_queue-1.0.5

          for i in libmnl libnfnetlink libnetfilter_queue; do
            (
              cd $i-*
              CFLAGS="-Os -flto=auto -Wno-implicit-function-declaration" \
              ./configure --prefix= --host=$TARGET --enable-static --disable-shared --disable-dependency-tracking
              make install -j$(nproc) DESTDIR=$DEPS_DIR
            )
            sed -i "s|^prefix=.*|prefix=$DEPS_DIR|g" $DEPS_DIR/lib/pkgconfig/$i.pc
          done

          CFLAGS="-DZAPRET_GH_VER=${{ github.ref_name }} -DZAPRET_GH_HASH=${{ github.sha }} -I$DEPS_DIR/include" \
          LDFLAGS="-L$DEPS_DIR/lib" \
          make -C zapret android -j$(nproc)

      - name: Upload zapret binaries
        uses: actions/upload-artifact@v4
        with:
          name: nfqws-${{ matrix.abi }}
          path: zapret/binaries/my/nfqws

  build-dnscrypt:
    name: Build dnscrypt-proxy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: DNSCrypt/dnscrypt-proxy
          path: dnscrypt-proxy

      - uses: actions/setup-go@v5
        with:
          go-version: 1
          check-latest: true

      - name: Build All
        run: |
          cd dnscrypt-proxy/dnscrypt-proxy
          curl -sSL "https://raw.githubusercontent.com/${{ github.repository }}/refs/heads/main/.github/modified-ci-build.sh" | bash
          mkdir -p binaries
          mv dnscrypt-proxy-* binaries/

      - uses: actions/upload-artifact@v4
        with:
          name: dnscrypt-proxy
          path: dnscrypt-proxy/dnscrypt-proxy/binaries/*

  build-curl:
    name: Build curl for Android
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - abi: armeabi-v7a
            target: armv7a-linux-androideabi
            openssl: android-arm
          - abi: arm64-v8a
            target: aarch64-linux-android
            openssl: android-arm64
          - abi: x86
            target: i686-linux-android
            openssl: android-x86
          - abi: x86_64
            target: x86_64-linux-android
            openssl: android-x86_64
    steps:
      - name: Build curl
        env:
          TARGET: ${{ matrix.target }}
          OPENSSL_TARGET: ${{ matrix.openssl }}
          ABI: ${{ matrix.abi }}
        run: |
          export TOOLCHAIN=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64
          export API=21
          export PATH=$TOOLCHAIN/bin:$PATH
          export CC=${TARGET}${API}-clang
          export CXX=${TARGET}${API}-clang++
          export AR=llvm-ar
          export LD=ld.lld
          export RANLIB=llvm-ranlib
          export STRIP=llvm-strip

          curl -sSL https://www.openssl.org/source/openssl-3.3.0.tar.gz | tar -xz
          cd openssl-3.3.0
          ./Configure $OPENSSL_TARGET -D__ANDROID_API__=$API no-shared no-tests no-apps no-dso --prefix=$PWD/../openssl-out
          make install_sw -j$(nproc)
          cd ..

          curl -sSL https://curl.se/download/curl-8.7.1.tar.xz | tar -xJ
          cd curl-8.7.1
          ./configure --host=$TARGET --with-openssl=../openssl-out --disable-shared --enable-static --without-libidn2 --without-libssh2 --disable-ldap --disable-ldaps --disable-manual
          make -j$(nproc)
          $STRIP src/curl
          mv src/curl ../curl

      - uses: actions/upload-artifact@v4
        with:
          name: curl-${{ matrix.abi }}
          path: curl

  build-module:
    name: Build Zapret Pocket Module
    runs-on: ubuntu-latest
    needs: [build-zapret, build-dnscrypt, build-curl]
    steps:
      - uses: actions/checkout@v4

      # Download artifacts from previous jobs
      - uses: actions/download-artifact@v4
        with:
          name: nfqws-armeabi-v7a
          path: module
      - run: mv module/nfqws module/zapret/nfqws-arm

      - uses: actions/download-artifact@v4
        with:
          name: nfqws-arm64-v8a
          path: module
      - run: mv module/nfqws module/zapret/nfqws-aarch64

      - uses: actions/download-artifact@v4
        with:
          name: nfqws-x86
          path: module
      - run: mv module/nfqws module/zapret/nfqws-x86

      - uses: actions/download-artifact@v4
        with:
          name: nfqws-x86_64
          path: module
      - run: mv module/nfqws module/zapret/nfqws-x86_64

      # Download curl binaries
      - uses: actions/download-artifact@v4
        with:
          name: curl-armeabi-v7a
          path: module
      - run: mv module/curl module/curl-arm

      - uses: actions/download-artifact@v4
        with:
          name: curl-arm64-v8a
          path: module
      - run: mv module/curl module/curl-aarch64

      - uses: actions/download-artifact@v4
        with:
          name: curl-x86
          path: module
      - run: mv module/curl module/curl-x86

      - uses: actions/download-artifact@v4
        with:
          name: curl-x86_64
          path: module
      - run: mv module/curl module/curl-x86_64

      # Download dnscrypt-proxy
      - uses: actions/download-artifact@v4
        with:
          name: dnscrypt-proxy
          path: module/dnscrypt

      # Build module zip
      - name: Build zapret-pocket.zip
        run: |
          version=${{ github.ref_name }}
          version_code=$(echo "${version}" | sed 's/[^0-9]//g')
          echo "version=${version}" >> $GITHUB_ENV
          echo "versionCode=${version_code}" >> $GITHUB_ENV

          sudo apt update
          sudo apt install -y p7zip-full jq
          cd module

          mkdir -p system/app ipset list
          apk_url=$(curl -s https://api.github.com/repos/Mygod/VPNHotspot/releases/latest | jq -r '.assets[] | select(.name | endswith(".apk")) | .browser_download_url')
          curl -L -o ./system/app/VpnHotspot.apk "$apk_url" || true
          curl -s https://raw.githubusercontent.com/sevcator/zapret-lists/refs/heads/main/ipset-v4.txt > ./ipset/ipset-v4.txt || true
          curl -s https://raw.githubusercontent.com/sevcator/zapret-lists/refs/heads/main/ipset-v6.txt > ./ipset/ipset-v6.txt || true
          curl -s https://raw.githubusercontent.com/sevcator/zapret-lists/refs/heads/main/reestr_filtered.txt -o ./list/reestr.txt || true
          curl -s https://raw.githubusercontent.com/sevcator/dnscrypt-proxy-stuff/refs/heads/main/cloaking-rules.txt -o ./dnscrypt/cloaking-rules.txt || true

          echo "id=zapret" > module.prop
          echo "name=zapret" >> module.prop
          echo "version=${version}" >> module.prop
          echo "versionCode=${version_code}" >> module.prop
          echo "author=sevcator, t.me/nigga2011, GAME-OVER-op, bol-van, DNSCrypt, ImMALWARE, Fenrir-0xFF, Flowseal, LeonMskRu" >> module.prop
          echo "description=âš¡ DPI bypass on Android with additional features" >> module.prop
          echo "updateJson=https://raw.githubusercontent.com/${{ github.repository }}/refs/heads/main/update.json" >> module.prop

          cd ..
          7z a zapret-pocket.zip ./module/*

      - name: Upload Module Zip
        uses: actions/upload-artifact@v4
        with:
          name: zapret-pocket
          path: zapret-pocket.zip
          if-no-files-found: error

      # Optional: Upload to GitHub Release
      - uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          fail_on_unmatched_files: true
          draft: false
          files: zapret-pocket.zip

      # Optional: Send to Telegram
      - name: Send to Telegram
        run: |
          curl -X POST \
            -F document=@"zapret-pocket.zip" \
            -F chat_id="${TELEGRAM_CHAT_ID}" \
            -F caption="$(echo -e "ðŸ”” <b>New release:</b> <a href=\"https://github.com/$GITHUB_REPOSITORY/releases/tag/$VERSION\">$VERSION</a>\nðŸ”‘ <b>SHA256:</b> $SHA256")" \
            -F parse_mode=HTML \
            -F disable_web_page_preview=true \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendDocument?chat_id=${TELEGRAM_CHAT_ID}"
        env:
          VERSION: ${{ github.ref_name }}
          SHA256: ${{ env.SHA256 }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
